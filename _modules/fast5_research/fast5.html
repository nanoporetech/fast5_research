

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>fast5_research.fast5 &mdash; Fast5_research 1.2.22 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Fast5_research
          

          
          </a>

          
            
            
              <div class="version">
                1.2.22
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Fast5 Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cmdline.html">Command line Programs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../fast5_research.html">fast5_research package</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Fast5_research</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>fast5_research.fast5</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for fast5_research.fast5</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">iglob</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">h5py</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.lib.recfunctions</span> <span class="k">as</span> <span class="nn">nprf</span>
<span class="kn">import</span> <span class="nn">progressbar</span>

<span class="kn">from</span> <span class="nn">fast5_research.util</span> <span class="kn">import</span> <span class="n">dtype_descr</span>
<span class="kn">from</span> <span class="nn">fast5_research.util</span> <span class="kn">import</span> <span class="n">mad</span>
<span class="kn">from</span> <span class="nn">fast5_research.util</span> <span class="kn">import</span> <span class="n">docstring_parameter</span>
<span class="kn">from</span> <span class="nn">fast5_research.util</span> <span class="kn">import</span> <span class="n">readtsv</span>

<span class="kn">from</span> <span class="nn">fast5_research.util</span> <span class="kn">import</span> <span class="n">validate_event_table</span><span class="p">,</span> <span class="n">validate_model_table</span><span class="p">,</span> <span class="n">validate_scale_object</span><span class="p">,</span> <span class="n">_clean_attrs</span>
<span class="kn">from</span> <span class="nn">fast5_research.util</span> <span class="kn">import</span> <span class="n">create_basecall_1d_output</span><span class="p">,</span> <span class="n">create_mapping_output</span><span class="p">,</span> <span class="n">mean_qscore</span><span class="p">,</span> <span class="n">qstring_to_phred</span><span class="p">,</span> <span class="n">_sanitize_data_for_writing</span><span class="p">,</span> <span class="n">_sanitize_data_for_reading</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;always&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>


<div class="viewcode-block" id="Fast5"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5">[docs]</a><span class="k">class</span> <span class="nc">Fast5</span><span class="p">(</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for grabbing data from single read fast5 files. Many attributes/</span>
<span class="sd">    groups are assumed to exist currently (we&#39;re concerned mainly with reading).</span>
<span class="sd">    Needs some development to make robust and for writing.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__base_analysis__</span> <span class="o">=</span> <span class="s1">&#39;/Analyses&#39;</span>
    <span class="n">__event_detect_name__</span> <span class="o">=</span> <span class="s1">&#39;EventDetection&#39;</span>
    <span class="n">__raw_path__</span> <span class="o">=</span> <span class="s1">&#39;/Raw/Reads&#39;</span>
    <span class="n">__raw_name_old__</span> <span class="o">=</span> <span class="s1">&#39;RawData&#39;</span>
    <span class="n">__raw_path_old__</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__base_analysis__</span><span class="p">,</span> <span class="n">__raw_name_old__</span><span class="p">)</span>
    <span class="n">__raw_signal_path_old__</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/Signal&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__raw_path_old__</span><span class="p">)</span>
    <span class="n">__raw_meta_path_old__</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/Meta&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__raw_path_old__</span><span class="p">)</span>
    <span class="n">__channel_meta_path__</span> <span class="o">=</span> <span class="s1">&#39;/UniqueGlobalKey/channel_id&#39;</span>
    <span class="n">__tracking_id_path__</span> <span class="o">=</span> <span class="s1">&#39;UniqueGlobalKey/tracking_id&#39;</span>
    <span class="n">__context_tags_path__</span> <span class="o">=</span> <span class="s1">&#39;UniqueGlobalKey/context_tags&#39;</span>

    <span class="n">__default_event_path__</span> <span class="o">=</span> <span class="s1">&#39;Reads&#39;</span>

    <span class="n">__default_basecall_1d_analysis__</span> <span class="o">=</span> <span class="s1">&#39;Basecall_1D&#39;</span>

    <span class="n">__default_seq_section__</span> <span class="o">=</span> <span class="s1">&#39;template&#39;</span>
    <span class="n">__default_basecall_fastq__</span> <span class="o">=</span> <span class="s1">&#39;BaseCalled_</span><span class="si">{}</span><span class="s1">/Fastq&#39;</span>
    <span class="n">__default_basecall_1d_events__</span> <span class="o">=</span> <span class="s1">&#39;BaseCalled_</span><span class="si">{}</span><span class="s1">/Events&#39;</span>
    <span class="n">__default_basecall_1d_model__</span> <span class="o">=</span> <span class="s1">&#39;BaseCalled_</span><span class="si">{}</span><span class="s1">/Model&#39;</span>
    <span class="n">__default_basecall_1d_summary__</span> <span class="o">=</span> <span class="s1">&#39;Summary/basecall_1d_</span><span class="si">{}</span><span class="s1">&#39;</span>

    <span class="n">__default_alignment_analysis__</span> <span class="o">=</span> <span class="s1">&#39;Alignment&#39;</span>

    <span class="n">__default_section__</span> <span class="o">=</span> <span class="s1">&#39;template&#39;</span>

    <span class="n">__default_mapping_analysis__</span> <span class="o">=</span> <span class="s1">&#39;Squiggle_Map&#39;</span>
    <span class="n">__default_mapping_events__</span> <span class="o">=</span> <span class="s1">&#39;SquiggleMapped_</span><span class="si">{}</span><span class="s1">/Events&#39;</span>
    <span class="n">__default_mapping_model__</span> <span class="o">=</span> <span class="s1">&#39;SquiggleMapped_</span><span class="si">{}</span><span class="s1">/Model&#39;</span>
    <span class="n">__default_mapping_summary__</span> <span class="o">=</span> <span class="s1">&#39;Summary/squiggle_map_</span><span class="si">{}</span><span class="s1">&#39;</span>

    <span class="n">__default_substep_mapping_analysis__</span> <span class="o">=</span> <span class="s1">&#39;Substate_Map&#39;</span>
    <span class="n">__default_substep_mapping_events__</span> <span class="o">=</span> <span class="s1">&#39;/Events&#39;</span>

    <span class="n">__default_basecall_mapping_analysis__</span> <span class="o">=</span> <span class="s1">&#39;AlignToRef&#39;</span>
    <span class="n">__default_basecall_mapping_events__</span> <span class="o">=</span> <span class="s1">&#39;CurrentSpaceMapped_</span><span class="si">{}</span><span class="s1">/Events/&#39;</span>
    <span class="n">__default_basecall_mapping_model__</span> <span class="o">=</span> <span class="s1">&#39;CurrentSpaceMapped_</span><span class="si">{}</span><span class="s1">/Model/&#39;</span>
    <span class="n">__default_basecall_mapping_summary__</span> <span class="o">=</span> <span class="s1">&#39;/Summary/current_space_map_</span><span class="si">{}</span><span class="s1">/&#39;</span> <span class="c1"># under AlignToRef analysis</span>
    <span class="n">__default_basecall_alignment_summary__</span> <span class="o">=</span> <span class="s1">&#39;/Summary/genome_mapping_</span><span class="si">{}</span><span class="s1">/&#39;</span> <span class="c1"># under Alignment analysis</span>

    <span class="n">__default_engine_state_path__</span> <span class="o">=</span> <span class="s1">&#39;/EngineStates/&#39;</span>
    <span class="n">__temp_fields__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;heatsink&#39;</span><span class="p">,</span> <span class="s1">&#39;asic&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Fast5</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">read</span><span class="p">)</span>

        <span class="c1"># Attach channel_meta as attributes, slightly redundant</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_clean_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__channel_meta_path__</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="c1"># Backward compat.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling_rate</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filename_short</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">short_name_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;ch\d+_file\d+&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename_short</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_short</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename_short</span>
        <span class="k">if</span> <span class="n">short_name_match</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name_short</span> <span class="o">=</span> <span class="n">short_name_match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>


<div class="viewcode-block" id="Fast5.New"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.New">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">New</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">tracking_id</span><span class="o">=</span><span class="p">{},</span> <span class="n">context_tags</span><span class="o">=</span><span class="p">{},</span> <span class="n">channel_id</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Construct a fresh single-read file, with meta data written to</span>
<span class="sd">        standard locations.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">read</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;New file can only be opened with &#39;a&#39; or &#39;w&#39; intent.&quot;</span><span class="p">)</span>

        <span class="n">channel_id</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert_channel_id</span><span class="p">(</span><span class="n">channel_id</span><span class="p">)</span>
        <span class="n">tracking_id</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert_tracking_id</span><span class="p">(</span><span class="n">tracking_id</span><span class="p">)</span>


        <span class="c1"># Start a new file, populate it with meta</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">read</span><span class="p">)</span> <span class="k">as</span> <span class="n">h</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">_sanitize_data_for_writing</span><span class="p">(</span><span class="s1">&#39;file_version&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_sanitize_data_for_writing</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">location</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="p">[</span><span class="n">tracking_id</span><span class="p">,</span> <span class="n">context_tags</span><span class="p">],</span>
                <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">__tracking_id_path__</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__context_tags_path__</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="c1"># cjw: no idea why these must be str, just following ossetra</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_add_attrs_to_fh</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
            <span class="c1"># These aren&#39;t forced to be str</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_add_attrs_to_fh</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__channel_meta_path__</span><span class="p">)</span>

        <span class="c1"># return instance from new file</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_add_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convenience method for adding attrs to a possibly new group.</span>
<span class="sd">        :param data: dict of attrs to add</span>
<span class="sd">        :param location: hdf path</span>
<span class="sd">        :param convert: function to apply to all dictionary values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_attrs_to_fh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_add_attrs_to_fh</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implementation of _add_attrs as staticmethod. This allows</span>
<span class="sd">        functionality to be used in .New() constructor but is otherwise nasty!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">location</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="n">location</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">convert</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">attrs</span><span class="p">[</span><span class="n">_sanitize_data_for_writing</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_sanitize_data_for_writing</span><span class="p">(</span><span class="n">convert</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attrs</span><span class="p">[</span><span class="n">_sanitize_data_for_writing</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_sanitize_data_for_writing</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>


<div class="viewcode-block" id="Fast5.convert_channel_id"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.convert_channel_id">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_channel_id</span><span class="p">(</span><span class="n">channel_id</span><span class="p">):</span>
        <span class="c1"># channel_id: spec. requires these</span>
        <span class="n">req_fields</span> <span class="o">=</span> <span class="p">{</span>
                      <span class="s1">&#39;digitisation&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;f8&#39;</span><span class="p">),</span>
                      <span class="s1">&#39;offset&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;f8&#39;</span><span class="p">),</span>
                      <span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;f8&#39;</span><span class="p">),</span>
                      <span class="s1">&#39;sampling_rate&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;f8&#39;</span><span class="p">),</span>
                      <span class="s1">&#39;channel_number&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">req_fields</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">channel_id</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="s1">&#39;channel_id does not contain required fields: </span><span class="si">{}</span><span class="s1">,</span><span class="se">\n</span><span class="s1">got </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">channel_id</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="p">)</span>
        <span class="n">channel_id</span> <span class="o">=</span> <span class="n">_type_meta</span><span class="p">(</span><span class="n">channel_id</span><span class="p">,</span> <span class="n">req_fields</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">channel_id</span></div>


<div class="viewcode-block" id="Fast5.convert_tracking_id"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.convert_tracking_id">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_tracking_id</span><span class="p">(</span><span class="n">tracking_id</span><span class="p">):</span>
        <span class="c1"># tracking_id: spec. says this group should be present as string, says</span>
        <span class="c1">#   nothing about required keys, but certain software require the</span>
        <span class="c1">#   following minimal set</span>
        <span class="n">req_fields</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># guppy</span>
            <span class="s1">&#39;exp_start_time&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;U20&#39;</span><span class="p">),</span>  <span class="c1"># e.g. &#39;1970-01-01T00:00:00Z&#39;</span>
            <span class="s1">&#39;run_id&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;U32&#39;</span><span class="p">),</span>          <span class="c1">#      &#39;118ea414303a46d892603141b9cbd7b0&#39;</span>
            <span class="s1">&#39;flow_cell_id&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;U8&#39;</span><span class="p">),</span>     <span class="c1">#      &#39;FAH12345&#39;</span>
            <span class="c1"># ...add others</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">req_fields</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tracking_id</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="s1">&#39;tracking_id does not contain required fields: </span><span class="si">{}</span><span class="s1">,</span><span class="se">\n</span><span class="s1">got </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">tracking_id</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="p">)</span>
        <span class="n">tracking_id</span> <span class="o">=</span> <span class="n">_type_meta</span><span class="p">(</span><span class="n">tracking_id</span><span class="p">,</span> <span class="n">req_fields</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tracking_id</span></div>


<div class="viewcode-block" id="Fast5.convert_raw_meta"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.convert_raw_meta">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_raw_meta</span><span class="p">(</span><span class="n">meta</span><span class="p">):</span>
        <span class="n">req_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;start_time&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;u8&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;u4&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;read_number&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;i4&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;start_mux&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;u1&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;read_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="s1">&#39;median_before&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;f8&#39;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">req_keys</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">req_keys</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="s1">&#39;Raw meta data must contain keys: </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="p">)</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">_type_meta</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">req_keys</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">meta</span></div>
    

    <span class="k">def</span> <span class="nf">_add_string_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;Need to supply a string&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">_sanitize_data_for_writing</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_add_numpy_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">_sanitize_data_for_writing</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">compression</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_add_event_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
        <span class="n">validate_event_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_numpy_table</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_join_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">writable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Can we write to the file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">is</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>


<div class="viewcode-block" id="Fast5.assert_writable"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.assert_writable">[docs]</a>    <span class="k">def</span> <span class="nf">assert_writable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">writable</span><span class="p">,</span> <span class="s2">&quot;File not writable, opened with </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">channel_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Channel meta information as python dict&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_clean_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__channel_meta_path__</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tracking_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tracking id meta information as python dict&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_clean_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__tracking_id_path__</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">context_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Context tags meta information as python dict&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_clean_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__context_tags_path__</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attributes for a read, assumes one read in file&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_clean_attrs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_read</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_clean_attrs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_read</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>


<div class="viewcode-block" id="Fast5.summary"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rename</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A read summary, assumes one read in file&quot;&quot;&quot;</span>
        <span class="n">to_rename</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;start_mux&#39;</span><span class="p">,</span> <span class="s1">&#39;abasic_found&#39;</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="s1">&#39;median_before&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;mux&#39;</span><span class="p">,</span> <span class="s1">&#39;abasic&#39;</span><span class="p">,</span> <span class="s1">&#39;strand_duration&#39;</span><span class="p">,</span> <span class="s1">&#39;pore_before&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">to_delete</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;read_number&#39;</span><span class="p">,</span> <span class="s1">&#39;scaling_used&#39;</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;run_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracking_id</span><span class="p">[</span><span class="s1">&#39;run_id&#39;</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_meta</span><span class="p">[</span><span class="s1">&#39;channel_number&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_meta</span><span class="p">[</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_meta</span><span class="p">[</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">rename</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">to_rename</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">if</span> <span class="n">delete</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">to_delete</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="Fast5.strip_analyses"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.strip_analyses">[docs]</a>    <span class="k">def</span> <span class="nf">strip_analyses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_000&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__event_detect_name__</span><span class="p">),</span> <span class="n">__raw_name_old__</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;Remove all analyses from file</span>

<span class="sd">        :param keep: whitelist of analysis groups to keep</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">analyses</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__base_analysis__</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">analyses</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">analyses</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>


<div class="viewcode-block" id="Fast5.repack"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.repack">[docs]</a>    <span class="k">def</span> <span class="nf">repack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pack_opts</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run h5repack on the current file. Returns a fresh object.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">path_tmp</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.tmp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pack_opts</span> <span class="o">=</span> <span class="n">pack_opts</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;h5repack&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pack_opts</span> <span class="o">+</span> <span class="p">[</span><span class="n">path</span><span class="p">,</span> <span class="n">path_tmp</span><span class="p">])</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">path_tmp</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Fast5</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span></div>


    <span class="c1">###</span>
    <span class="c1"># Extracting read event data</span>

<div class="viewcode-block" id="Fast5.get_reads"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.get_reads">[docs]</a>    <span class="k">def</span> <span class="nf">get_reads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">read_numbers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterator across event data for all reads in file</span>

<span class="sd">        :param group: return hdf group rather than event data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">raw</span><span class="p">:</span>
            <span class="n">event_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_latest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__event_detect_name__</span><span class="p">)</span>
            <span class="n">event_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">event_group</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_event_path__</span><span class="p">)</span>
            <span class="n">reads</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">event_path</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">reads</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__raw_path__</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_raw</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">read_numbers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">it</span> <span class="o">=</span> <span class="n">reads</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">it</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">reads</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                  <span class="k">if</span> <span class="n">_clean_attrs</span><span class="p">(</span><span class="n">reads</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)[</span><span class="s1">&#39;read_number&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">read_numbers</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">read</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">reads</span><span class="p">[</span><span class="n">read</span><span class="p">],</span> <span class="n">read</span>
        <span class="k">elif</span> <span class="n">group</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">read</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">reads</span><span class="p">[</span><span class="n">read</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">read</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">raw</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_data</span><span class="p">(</span><span class="n">reads</span><span class="p">[</span><span class="n">read</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_data_raw</span><span class="p">(</span><span class="n">reads</span><span class="p">[</span><span class="n">read</span><span class="p">])</span></div>


<div class="viewcode-block" id="Fast5.get_read"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.get_read">[docs]</a>    <span class="k">def</span> <span class="nf">get_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">read_number</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Like get_reads, but only the first read in the file</span>

<span class="sd">        :param group: return hdf group rather than event/raw data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">read_number</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reads</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">raw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reads</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">raw</span><span class="p">,</span> <span class="n">read_numbers</span><span class="o">=</span><span class="p">[</span><span class="n">read_number</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">next</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">gen</span><span class="p">))</span></div>


    <span class="k">def</span> <span class="nf">_get_read_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Private accessor to read event data&quot;&quot;&quot;</span>
        <span class="c1"># We choose the following to always be floats</span>
        <span class="n">float_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;stdv&#39;</span><span class="p">)</span>

        <span class="n">events</span> <span class="o">=</span> <span class="n">read</span><span class="p">[</span><span class="s1">&#39;Events&#39;</span><span class="p">]</span>

        <span class="c1"># We assume that if start is an int or uint the data is in samples</span>
        <span class="c1">#    else it is in seconds already.</span>
        <span class="n">needs_scaling</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">events</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">]:</span>
            <span class="n">needs_scaling</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span>
            <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;float&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">float_fields</span> <span class="k">else</span> <span class="n">d</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dtype_descr</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="n">events</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">events</span><span class="p">[()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;Cannot retrieve events using </span><span class="si">{}</span><span class="s1"> as indices&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
                    <span class="p">)</span>

        <span class="c1"># File spec mentions a read.attrs[&#39;scaling_used&#39;] attribute,</span>
        <span class="c1">#    its not clear what this is. We&#39;ll ignore it and hope for</span>
        <span class="c1">#    the best.</span>
        <span class="k">if</span> <span class="n">needs_scaling</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span>
        <span class="k">return</span> <span class="n">_sanitize_data_for_reading</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_get_read_data_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Private accessor to read raw data&quot;&quot;&quot;</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">read</span><span class="p">[</span><span class="s1">&#39;Signal&#39;</span><span class="p">]</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span> <span class="k">if</span> <span class="n">scale</span> <span class="k">else</span> <span class="nb">int</span>

        <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="n">raw</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;Cannot retrieve events using </span><span class="si">{}</span><span class="s1"> as indices&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
                    <span class="p">)</span>

        <span class="c1"># Scale data to pA</span>
        <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_meta</span>
            <span class="n">raw_unit</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;digitisation&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">raw_unit</span>
        <span class="k">return</span> <span class="n">data</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_convert_meta_times</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">):</span>
        <span class="c1"># Metadata should be written in samples (int), not seconds (float)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">],</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">))</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">meta</span>


<div class="viewcode-block" id="Fast5.set_read"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.set_read">[docs]</a>    <span class="k">def</span> <span class="nf">set_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">meta</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write event data to file</span>

<span class="sd">        :param data: event data</span>
<span class="sd">        :param meta: meta data to attach to read</span>
<span class="sd">        :param read_number: per-channel read counter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">req_fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;start_time&#39;</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="s1">&#39;read_number&#39;</span><span class="p">,</span>
            <span class="s1">&#39;start_mux&#39;</span><span class="p">,</span> <span class="s1">&#39;read_id&#39;</span><span class="p">,</span> <span class="s1">&#39;scaling_used&#39;</span><span class="p">,</span> <span class="s1">&#39;median_before&#39;</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">req_fields</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="s1">&#39;Read meta does not contain required fields: </span><span class="si">{}</span><span class="s1">, got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">req_fields</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">req_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;stdv&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Data is not ndarray.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">req_fields</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="s1">&#39;Read data does not contain required fields: </span><span class="si">{}</span><span class="s1">, got </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">req_fields</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">event_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__event_detect_name__</span><span class="p">)</span>
        <span class="n">event_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">event_group</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_event_path__</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span>
            <span class="n">event_path</span><span class="p">,</span> <span class="s1">&#39;Read_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;read_number&#39;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="c1"># Metadata should be written in samples (int), not seconds (float)</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_meta_times</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_attrs</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>


        <span class="n">uint_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">)</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span>
            <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;uint32&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">uint_fields</span> <span class="k">else</span> <span class="n">d</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dtype_descr</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="c1"># (see _get_read_data()). If the data is not an int or uint</span>
        <span class="c1">#    we assume it is in seconds and scale appropriately</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">]:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_event_table</span><span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;Events&#39;</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Fast5.get_read_stats"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.get_read_stats">[docs]</a>    <span class="k">def</span> <span class="nf">get_read_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Combines stats based on events with output of .summary, assumes a</span>
<span class="sd">        one read file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
        <span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_read</span><span class="p">()</span>
        <span class="n">n_events</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">read</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">read</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">90</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;range_current&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;median_current&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_events&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_events</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;median_sd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">read</span><span class="p">[</span><span class="s1">&#39;stdv&#39;</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;median_dwell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">read</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;sd_current&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">read</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;mad_current&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mad</span><span class="p">(</span><span class="n">read</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;eps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_events&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;strand_duration&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span></div>

    <span class="c1">###</span>
    <span class="c1"># Raw Data</span>

<div class="viewcode-block" id="Fast5.get_raw"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.get_raw">[docs]</a>    <span class="nd">@docstring_parameter</span><span class="p">(</span><span class="n">__raw_path_old__</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get raw data in file, might not be present.</span>

<span class="sd">        :param scale: Scale data to pA? (rather than ADC values)</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This method is deprecated and should not be used, instead use</span>
<span class="sd">            .get_read(raw=True) to read both MinKnow conformant files</span>
<span class="sd">            and previous Tang files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;&#39;Fast5.get_raw()&#39; is deprecated, use &#39;Fast5.get_read(raw=True)&#39;.&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__raw_signal_path_old__</span><span class="p">]</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">_clean_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__raw_meta_path_old__</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No raw data available.&#39;</span><span class="p">)</span>

        <span class="n">raw_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
            <span class="n">raw_data</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[()]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
            <span class="n">raw_unit</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;digitisation&#39;</span><span class="p">]</span>
            <span class="n">raw_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">raw_data</span> <span class="o">+</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">raw_unit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">raw_data</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[()]</span>
        <span class="k">return</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;sample_rate&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="Fast5.set_raw"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.set_raw">[docs]</a>    <span class="k">def</span> <span class="nf">set_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">read_number</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the raw data in file.</span>

<span class="sd">        :param raw: raw data to add</span>
<span class="sd">        :param read_number: read number (as usually given in filename and</span>
<span class="sd">            contained within HDF paths, viz. Reads/Read_&lt;&gt;/). If not given</span>
<span class="sd">            attempts will be made to guess the number (assumes single read</span>
<span class="sd">            per file).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Enforce raw is 16bit int, don&#39;t try to second guess if not</span>
        <span class="k">if</span> <span class="n">raw</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Raw data must be of type int16.&#39;</span><span class="p">)</span>

        <span class="c1"># Attempt to guess read_number and meta from event detection group</span>
        <span class="k">if</span> <span class="n">read_number</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exception</span> <span class="o">=</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;&#39;read_number&#39; not given and cannot guess.&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">n_reads</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reads</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="c1"># if no events present</span>
                <span class="k">raise</span> <span class="n">exception</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n_reads</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">read_number</span> <span class="o">=</span> <span class="n">_clean_attrs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_read</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="p">)[</span><span class="s1">&#39;read_number&#39;</span><span class="p">]</span>
                    <span class="n">meta</span> <span class="o">=</span> <span class="n">_clean_attrs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_read</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">read_number</span><span class="o">=</span><span class="n">read_number</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exception</span>

        <span class="c1"># Metadata should be written in samples (int), not seconds (float)</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_meta_times</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">)</span>
        <span class="c1"># Ensure meta values are in correct type</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_raw_meta</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>

        <span class="c1"># Check meta is same as that for event data, if any</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">event_meta</span> <span class="o">=</span> <span class="n">_clean_attrs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_read</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">read_number</span><span class="o">=</span><span class="n">read_number</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="n">event_meta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Attempted to set raw meta data as </span><span class="si">{}</span><span class="s2"> &quot;</span>
                    <span class="s2">&quot;but event meta is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">event_meta</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="c1"># Good to go!</span>
        <span class="n">read_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__raw_path__</span><span class="p">,</span> <span class="s1">&#39;Read_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">read_number</span><span class="p">))</span>
        <span class="n">data_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">read_path</span><span class="p">,</span> <span class="s1">&#39;Signal&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_attrs</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">read_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">data_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw</span></div>


<div class="viewcode-block" id="Fast5.set_raw_old"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.set_raw_old">[docs]</a>    <span class="k">def</span> <span class="nf">set_raw_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw</span><span class="p">,</span> <span class="n">meta</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the raw data in file.</span>

<span class="sd">        :param raw: raw data to add</span>
<span class="sd">        :param meta: meta data dictionary</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This method does not write raw data conforming to the Fast5</span>
<span class="sd">            specification. This class will currently still read data</span>
<span class="sd">            written by this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;.set_raw() does not conform to the Fast5 spec.. Although this &quot;</span>
            <span class="s2">&quot;class will read data written by this method, other tools &quot;</span>
            <span class="s2">&quot;may fail to read the resultant file.&quot;</span><span class="p">,</span>
            <span class="ne">FutureWarning</span>
        <span class="p">)</span>

        <span class="c1"># Verify meta conforms to our standard</span>
        <span class="n">req_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="s1">&#39;digitisation&#39;</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="s1">&#39;sample_rate&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">req_fields</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="s1">&#39;raw meta data dictionary must contain </span><span class="si">{}</span><span class="s1"> fields.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req_fields</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;sample_rate&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span> <span class="c1"># is this a sensible error?</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Tried to set raw data with sample rate </span><span class="si">{}</span><span class="s1">, should be </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;sample_rate&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__raw_signal_path_old__</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_attrs</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__raw_meta_path_old__</span><span class="p">)</span></div>


    <span class="c1">###</span>
    <span class="c1"># Analysis path resolution</span>

<div class="viewcode-block" id="Fast5.get_analysis_latest"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.get_analysis_latest">[docs]</a>    <span class="k">def</span> <span class="nf">get_analysis_latest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get group of latest (present) analysis with a given base path.</span>

<span class="sd">        :param name: Get the (full) path of newest analysis with a given base</span>
<span class="sd">            name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__base_analysis__</span><span class="p">,</span>
                <span class="nb">sorted</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__base_analysis__</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;No analyses with name </span><span class="si">{}</span><span class="s1"> present.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span></div>


<div class="viewcode-block" id="Fast5.get_analysis_new"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.get_analysis_new">[docs]</a>    <span class="k">def</span> <span class="nf">get_analysis_new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get group path for new analysis with a given base name.</span>

<span class="sd">        :param name: desired analysis name</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Formatted as &#39;base/name_000&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">latest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_latest</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">root</span><span class="p">,</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">latest</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="c1"># Nothing present</span>
            <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__base_analysis__</span><span class="p">,</span> <span class="n">name</span>
            <span class="p">)</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span></div>


<div class="viewcode-block" id="Fast5.get_model"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.get_model">[docs]</a>    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">__default_section__</span><span class="p">,</span> <span class="n">analysis</span><span class="o">=</span><span class="n">__default_mapping_analysis__</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get model used for squiggle mapping&quot;&quot;&quot;</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_latest</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_mapping_model__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">model_path</span><span class="p">][()]</span></div>

    <span class="c1"># The remaining are methods to read and write data as chimaera produces</span>
    <span class="c1">#    It is necessarily all a bit nasty, but should provide a more</span>
    <span class="c1">#    consistent interface to the files. Paths are defaulted</span>

    <span class="c1">###</span>
    <span class="c1"># Temperature etc.</span>

<div class="viewcode-block" id="Fast5.get_engine_state"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.get_engine_state">[docs]</a>    <span class="nd">@docstring_parameter</span><span class="p">(</span><span class="n">__default_engine_state_path__</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_engine_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve engine state from {}, either across the whole read</span>
<span class="sd">        (default) or at a given time.</span>

<span class="sd">        :param state: name of engine state</span>
<span class="sd">        :param time: time (in seconds) at which to retrieve temperature</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__default_engine_state_path__</span><span class="p">,</span> <span class="n">state</span>
        <span class="p">)</span>
        <span class="n">states</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">location</span><span class="p">][()]</span>
        <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">states</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">states</span><span class="p">[</span><span class="n">state</span><span class="p">][</span><span class="n">i</span><span class="p">]</span></div>


<div class="viewcode-block" id="Fast5.get_temperature"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.get_temperature">[docs]</a>    <span class="nd">@docstring_parameter</span><span class="p">(</span><span class="n">__default_engine_state_path__</span><span class="p">,</span> <span class="n">__temp_fields__</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">__temp_fields__</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve temperature data from {}, either across the whole read</span>
<span class="sd">        (default) or at a given time.</span>

<span class="sd">        :param time: time at which to get temperature</span>
<span class="sd">        :param field: one of {}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__temp_fields__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;&#39;field&#39; argument must be one of </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__temp_fields__</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_engine_state</span><span class="p">(</span><span class="s1">&#39;minion_</span><span class="si">{}</span><span class="s1">_temperature&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="n">time</span><span class="p">)</span></div>


<div class="viewcode-block" id="Fast5.set_engine_state"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.set_engine_state">[docs]</a>    <span class="k">def</span> <span class="nf">set_engine_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the engine state data.</span>

<span class="sd">        :param data: a 1D-array containing two fields, the first of which</span>
<span class="sd">            must be named &#39;time&#39;. The name of the second field will be used</span>
<span class="sd">            to name the engine state and be used in the dataset path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
        <span class="k">if</span> <span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;First field of engine state data must be &#39;time&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Engine state data must contain exactly two fields.&quot;</span><span class="p">)</span>

        <span class="n">state</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__default_engine_state_path__</span><span class="p">,</span> <span class="n">state</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span></div>


    <span class="c1">###</span>
    <span class="c1"># Template/adapter splitting data</span>
    <span class="n">__default_split_analysis__</span><span class="o">=</span> <span class="s1">&#39;Segment_Linear&#39;</span>
    <span class="n">__split_summary_location__</span> <span class="o">=</span> <span class="s1">&#39;/Summary/split_adapter&#39;</span>

<div class="viewcode-block" id="Fast5.set_split_data"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.set_split_data">[docs]</a>    <span class="nd">@docstring_parameter</span><span class="p">(</span><span class="n">__base_analysis__</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_split_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">analysis</span><span class="o">=</span><span class="n">__default_split_analysis__</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write a dict containing split point data.</span>

<span class="sd">        :param data: `dict`-like object containing attrs to add</span>
<span class="sd">        :param analysis: Base analysis name (under {})</span>

<span class="sd">        .. warning::</span>
<span class="sd">            Not checking currently for required fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_new</span><span class="p">(</span><span class="n">analysis</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__split_summary_location__</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_attrs</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span></div>


<div class="viewcode-block" id="Fast5.get_split_data"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.get_split_data">[docs]</a>    <span class="nd">@docstring_parameter</span><span class="p">(</span><span class="n">__base_analysis__</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_split_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis</span><span class="o">=</span><span class="n">__default_split_analysis__</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get signal segmentation data.</span>

<span class="sd">        :param analysis: Base analysis name (under {})</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">analysis</span><span class="p">):</span>
            <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_latest</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s1">&#39;Summary&#39;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># there should be a single group under the above</span>
                <span class="n">grps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">location</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grps</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;Cannot find location containing split point data.&#39;</span><span class="p">)</span>
            <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">grps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_clean_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">location</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Could not retrieve signal split point data from attributes of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_inner</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># try a fallback location</span>
            <span class="k">return</span> <span class="n">_inner</span><span class="p">(</span><span class="s1">&#39;Adapter_Split&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Fast5.get_section_indices"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.get_section_indices">[docs]</a>    <span class="nd">@docstring_parameter</span><span class="p">(</span><span class="n">__base_analysis__</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_section_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis</span><span class="o">=</span><span class="n">__default_split_analysis__</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get two tuples indicating the event indices for signal</span>
<span class="sd">        segmentation boundaries.</span>

<span class="sd">        :param analysis: Base analysis path (under {})</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: if the below fails, calculating the values on the fly would be</span>
        <span class="c1">#       a useful feature. Which brings to mind could we do such a thing</span>
        <span class="c1">#       in all cases of missing data? Probably not reasonble.</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_split_data</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;start_index_temp&#39;</span><span class="p">],</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;end_index_temp&#39;</span><span class="p">]),</span>
                <span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;start_index_comp&#39;</span><span class="p">],</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;end_index_comp&#39;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not retrieve signal segmentation data.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Fast5.get_section_events"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.get_section_events">[docs]</a>    <span class="nd">@docstring_parameter</span><span class="p">(</span><span class="n">__base_analysis__</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_section_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">analysis</span><span class="o">=</span><span class="n">__default_split_analysis__</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the event data for a signal section</span>

<span class="sd">        :param analysis: Base analysis path (under {})</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_section_indices</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>
        <span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_read</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">events</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">section</span> <span class="o">==</span> <span class="s1">&#39;template&#39;</span><span class="p">:</span>
            <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_data</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">section</span> <span class="o">==</span> <span class="s1">&#39;complement&#39;</span><span class="p">:</span>
            <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_data</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;&quot;section&quot; parameter for fetching events must be &quot;template&quot; or &quot;complement&quot;.&#39;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">events</span></div>


    <span class="c1">###</span>
    <span class="c1"># 1D Basecalling data</span>

<div class="viewcode-block" id="Fast5.set_basecall_data"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.set_basecall_data">[docs]</a>    <span class="nd">@docstring_parameter</span><span class="p">(</span><span class="n">__base_analysis__</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_basecall_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span>
                          <span class="n">section</span><span class="o">=</span><span class="n">__default_section__</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
                          <span class="n">post</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">quality_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qstring</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">analysis</span><span class="o">=</span><span class="n">__default_basecall_1d_analysis__</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an annotated event table and 1D basecalling summary similiar</span>
<span class="sd">        to chimaera and add them to the fast5 file.</span>

<span class="sd">        :param events: Numpy record array of events. Must contain the mean,</span>
<span class="sd">            stdv, start and length fields.</span>
<span class="sd">        :param scale: Scaling object.</span>
<span class="sd">        :param path: Viterbi path containing model pointers (1D np.array).</span>
<span class="sd">        :param model: Model object.</span>
<span class="sd">        :param seq: Basecalled sequence string for fastq.</span>
<span class="sd">        :param section: String to use in paths, e.g. &#39;template&#39;.</span>
<span class="sd">        :param name: Identifier string for fastq.</span>
<span class="sd">        :param post: Numpy 2D array containing the posteriors (event, state), used to annotate events.</span>
<span class="sd">        :param score: Quality value for the whole strand.</span>
<span class="sd">        :param quality_data: Numpy 2D array containing quality_data, used to annotate events.</span>
<span class="sd">        :param qstring: Quality string for fastq.</span>
<span class="sd">        :param analysis: Base analysis name (under {})</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Validate input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assert_writable</span><span class="p">()</span>
        <span class="n">validate_event_table</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
        <span class="n">validate_scale_object</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="n">validate_model_table</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># Prepare paths</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_new</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>
        <span class="n">fastq_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_basecall_fastq__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
        <span class="n">events_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_basecall_1d_events__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_basecall_1d_model__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
        <span class="n">summary_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_basecall_1d_summary__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>

        <span class="c1"># Create annotated events and results</span>
        <span class="n">annot_events</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="n">create_basecall_1d_output</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;sequence_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;strand_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>

        <span class="c1"># Write fastq</span>
        <span class="k">if</span> <span class="n">qstring</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">qstring</span> <span class="o">=</span> <span class="s1">&#39;!&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qscores</span> <span class="o">=</span> <span class="n">qstring_to_phred</span><span class="p">(</span><span class="n">qstring</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;mean_qscore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_qscore</span><span class="p">(</span><span class="n">qscores</span><span class="p">)</span>

        <span class="n">fastq</span> <span class="o">=</span> <span class="s1">&#39;@</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s1">+</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">qstring</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_string_dataset</span><span class="p">(</span><span class="n">fastq</span><span class="p">,</span> <span class="n">fastq_path</span><span class="p">)</span>

        <span class="c1"># Write summary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_attrs</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">summary_path</span><span class="p">)</span>

        <span class="c1"># Write annotated events</span>
        <span class="n">read_meta</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;start_time&#39;</span><span class="p">:</span> <span class="n">annot_events</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">],</span>
            <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">annot_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">annot_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">annot_events</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_event_table</span><span class="p">(</span><span class="n">annot_events</span><span class="p">,</span> <span class="n">events_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_attrs</span><span class="p">(</span><span class="n">read_meta</span><span class="p">,</span> <span class="n">events_path</span><span class="p">)</span>

        <span class="c1"># Write model</span>
        <span class="n">scale_meta</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;shift&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="o">.</span><span class="n">shift</span><span class="p">,</span>
            <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
            <span class="s1">&#39;drift&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="o">.</span><span class="n">drift</span><span class="p">,</span>
            <span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="o">.</span><span class="n">var</span><span class="p">,</span>
            <span class="s1">&#39;scale_sd&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="o">.</span><span class="n">scale_sd</span><span class="p">,</span>
            <span class="s1">&#39;var_sd&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="o">.</span><span class="n">var_sd</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_numpy_table</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_attrs</span><span class="p">(</span><span class="n">scale_meta</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="Fast5.get_basecall_data"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.get_basecall_data">[docs]</a>    <span class="nd">@docstring_parameter</span><span class="p">(</span><span class="n">__base_analysis__</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_basecall_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">__default_section__</span><span class="p">,</span> <span class="n">analysis</span><span class="o">=</span><span class="n">__default_basecall_1d_analysis__</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the annotated basecall_1D events from the fast5 file.</span>

<span class="sd">        :param section: String to use in paths, e.g. &#39;template&#39;.</span>
<span class="sd">        :param analysis: Base analysis name (under {})</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_latest</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>
        <span class="n">events_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_basecall_1d_events__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># use _get_read_data to make sure int fields are converted as needed</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_data</span><span class="p">({</span><span class="s1">&#39;Events&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">[</span><span class="n">events_path</span><span class="p">]})</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not retrieve basecall_1D data from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">events_path</span><span class="p">))</span></div>


<div class="viewcode-block" id="Fast5.get_alignment_attrs"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.get_alignment_attrs">[docs]</a>    <span class="nd">@docstring_parameter</span><span class="p">(</span><span class="n">__base_analysis__</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_alignment_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">__default_section__</span><span class="p">,</span> <span class="n">analysis</span><span class="o">=</span><span class="n">__default_alignment_analysis__</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the annotated alignment meta data from the fast5 file.</span>

<span class="sd">        :param section: String to use in paths, e.g. &#39;template&#39;.</span>
<span class="sd">        :param analysis: Base analysis name (under {})</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">attrs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_latest</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>
        <span class="n">attr_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__default_basecall_alignment_summary__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">_clean_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">attr_path</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not retrieve alignment attributes from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr_path</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">attrs</span></div>

    <span class="c1">###</span>
    <span class="c1"># Mapping data</span>

<div class="viewcode-block" id="Fast5.set_mapping_data"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.set_mapping_data">[docs]</a>    <span class="nd">@docstring_parameter</span><span class="p">(</span><span class="n">__base_analysis__</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_mapping_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">ref_name</span><span class="p">,</span>
                         <span class="n">section</span><span class="o">=</span><span class="n">__default_section__</span><span class="p">,</span>
                         <span class="n">post</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">analysis</span><span class="o">=</span><span class="n">__default_mapping_analysis__</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an annotated event table and mapping summary similiar to</span>
<span class="sd">        chimaera and add them to the fast5 file.</span>

<span class="sd">        :param events: :class:`np.ndarray` of events. Must contain mean,</span>
<span class="sd">            stdv, start and length fields.</span>
<span class="sd">        :param scale: Scaling object.</span>
<span class="sd">        :param path: :class:`np.ndarray` containing position in reference.</span>
<span class="sd">            Negative values will be interpreted as &quot;bad emissions&quot;.</span>
<span class="sd">        :param model: Model object to use.</span>
<span class="sd">        :param seq: String representation of the reference sequence.</span>
<span class="sd">        :param section: Section of strand, e.g. &#39;template&#39;.</span>
<span class="sd">        :param name: Reference name.</span>
<span class="sd">        :param post: Two-dimensional :class:`np.ndarray` containing posteriors.</span>
<span class="sd">        :param score: Mapping quality score.</span>
<span class="sd">        :param is_reverse: Mapping refers to &#39;-&#39; strand (bool).</span>
<span class="sd">        :param analysis: Base analysis name (under {})</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Validate input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assert_writable</span><span class="p">()</span>
        <span class="n">validate_event_table</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
        <span class="n">validate_model_table</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">validate_scale_object</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s1">&#39;seq needs to be a str&#39;</span>

        <span class="c1"># Create annotated events and results</span>
        <span class="n">n_states</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">post</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_states</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s1">&#39;kmer&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">annot_events</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="n">create_mapping_output</span><span class="p">(</span>
            <span class="n">events</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="n">post</span><span class="p">,</span> <span class="n">is_reverse</span><span class="o">=</span><span class="n">is_reverse</span><span class="p">,</span> <span class="n">n_states</span><span class="o">=</span><span class="n">n_states</span>
        <span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;ref_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref_name</span>
        <span class="k">if</span> <span class="n">score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;strand_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>

        <span class="c1"># Create scale meta to be written with model</span>
        <span class="n">scale_meta</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;shift&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="o">.</span><span class="n">shift</span><span class="p">,</span>
            <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
            <span class="s1">&#39;drift&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="o">.</span><span class="n">drift</span><span class="p">,</span>
            <span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="o">.</span><span class="n">var</span><span class="p">,</span>
            <span class="s1">&#39;scale_sd&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="o">.</span><span class="n">scale_sd</span><span class="p">,</span>
            <span class="s1">&#39;var_sd&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="o">.</span><span class="n">var_sd</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_write_mapping_data</span><span class="p">(</span><span class="n">annot_events</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">scale_meta</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">analysis</span><span class="o">=</span><span class="n">analysis</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_write_mapping_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">annot_events</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">scale_meta</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span>
                            <span class="n">analysis</span><span class="o">=</span><span class="n">__default_mapping_analysis__</span><span class="p">):</span>

        <span class="c1"># Prepare paths</span>
        <span class="n">paths_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Squiggle_Map&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__default_mapping_analysis__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_mapping_events__</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">__default_mapping_model__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_mapping_summary__</span><span class="p">),</span>
            <span class="s1">&#39;AlignToRef&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__default_basecall_mapping_analysis__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_basecall_mapping_events__</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">__default_basecall_mapping_model__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_basecall_mapping_summary__</span><span class="p">)</span>
                      <span class="p">}</span>

        <span class="n">base</span><span class="p">,</span> <span class="n">event_path</span><span class="p">,</span> <span class="n">model_path</span><span class="p">,</span> <span class="n">summary_path</span> <span class="o">=</span> <span class="n">paths_dict</span><span class="p">[</span><span class="n">analysis</span><span class="p">]</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_new</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>
        <span class="n">event_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">event_path</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">model_path</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
        <span class="n">summary_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">summary_path</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>

        <span class="c1"># Write annotated events</span>
        <span class="n">read_meta</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;start_time&#39;</span><span class="p">:</span> <span class="n">annot_events</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">],</span>
            <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">annot_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">annot_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">annot_events</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_event_table</span><span class="p">(</span><span class="n">annot_events</span><span class="p">,</span> <span class="n">event_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_attrs</span><span class="p">(</span><span class="n">read_meta</span><span class="p">,</span> <span class="n">event_path</span><span class="p">)</span>

        <span class="c1"># Write model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_numpy_table</span><span class="p">(</span><span class="n">model</span><span class="p">,</span>  <span class="n">model_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_attrs</span><span class="p">(</span><span class="n">scale_meta</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>

        <span class="c1"># Write summary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_attrs</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">summary_path</span><span class="p">)</span>


<div class="viewcode-block" id="Fast5.get_mapping_data"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.get_mapping_data">[docs]</a>    <span class="nd">@docstring_parameter</span><span class="p">(</span><span class="n">__base_analysis__</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_mapping_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">__default_section__</span><span class="p">,</span> <span class="n">analysis</span><span class="o">=</span><span class="n">__default_mapping_analysis__</span><span class="p">,</span> <span class="n">get_model</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the annotated mapping events from the fast5 file.</span>

<span class="sd">        .. note::</span>
<span class="sd">            The seq_pos column for the events table returned from basecall_mapping is</span>
<span class="sd">            adjusted to be the genome position (consistent with squiggle_mapping)</span>

<span class="sd">        :param section: String to use in paths, e.g. &#39;template&#39;.</span>
<span class="sd">        :param analysis: Base analysis name (under {}). For basecall mapping</span>
<span class="sd">            use analysis = &#39;AlignToRef&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">events</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">analysis</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_mapping_analysis__</span><span class="p">:</span>
            <span class="c1"># squiggle_mapping</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_latest</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>
            <span class="n">event_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_mapping_events__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># use _get_read_data to make sure int fields are converted as needed</span>
                <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_data</span><span class="p">({</span><span class="s1">&#39;Events&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">[</span><span class="n">event_path</span><span class="p">]})</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not retrieve squiggle_mapping data from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event_path</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">get_model</span><span class="p">:</span>
                <span class="n">model_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_mapping_model__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">model_path</span><span class="p">][()]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not retrieve squiggle_mapping model from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_path</span><span class="p">))</span>

            <span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mapping_attrs</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">analysis</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_substep_mapping_analysis__</span><span class="p">:</span>
            <span class="c1"># substep mapping</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_latest</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>
            <span class="n">event_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_substep_mapping_events__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># use _get_read_data to make sure int fields are converted as needed</span>
                <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_data</span><span class="p">({</span><span class="s1">&#39;Events&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">[</span><span class="n">event_path</span><span class="p">]})</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not retrieve substep_mapping data from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event_path</span><span class="p">))</span>
            <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span>
            <span class="k">if</span> <span class="n">get_model</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Retrieving substep model not implemented.&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># basecall_mapping</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_latest</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>
            <span class="n">event_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_basecall_mapping_events__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># use _get_read_data to make sure int fields are converted as needed</span>
                <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_data</span><span class="p">({</span><span class="s1">&#39;Events&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">[</span><span class="n">event_path</span><span class="p">]})</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not retrieve basecall_mapping data from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event_path</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">get_model</span><span class="p">:</span>
                <span class="n">model_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_basecall_mapping_model__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">model_path</span><span class="p">][()]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not retrieve squiggle_mapping model from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_path</span><span class="p">))</span>

            <span class="c1"># Modify seq_pos to be the actual genome position (consistent with squiggle_map)</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mapping_attrs</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">,</span> <span class="n">analysis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__default_alignment_analysis__</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">events</span><span class="p">[</span><span class="s1">&#39;seq_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="s1">&#39;seq_pos&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ref_start&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">events</span><span class="p">[</span><span class="s1">&#39;seq_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ref_stop&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">events</span><span class="p">[</span><span class="s1">&#39;seq_pos&#39;</span><span class="p">]</span>

        <span class="c1"># add transition field</span>
        <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">move</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ediff1d</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="s1">&#39;seq_pos&#39;</span><span class="p">],</span> <span class="n">to_begin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                <span class="n">move</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="s1">&#39;move&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">events</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="n">events</span> <span class="o">=</span> <span class="n">nprf</span><span class="o">.</span><span class="n">append_fields</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="s1">&#39;move&#39;</span><span class="p">,</span> <span class="n">move</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">events</span><span class="p">[</span><span class="s1">&#39;move&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">move</span>

        <span class="k">if</span> <span class="n">get_model</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">events</span><span class="p">,</span> <span class="n">model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">events</span></div>


<div class="viewcode-block" id="Fast5.get_any_mapping_data"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.get_any_mapping_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_any_mapping_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">__default_section__</span><span class="p">,</span> <span class="n">attrs_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">get_model</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convenience method for extracting whatever mapping data might be</span>
<span class="sd">        present, favouring squiggle_mapping output over basecall_mapping.</span>

<span class="sd">        :param section: (Probably) &#39;template&#39;</span>
<span class="sd">        :param attrs_only: Use attrs_only=True to return mapping attributes without events</span>

<span class="sd">        :returns: the tuple (events, attrs) or attrs only</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">events</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs_only</span><span class="p">:</span>
                <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mapping_data</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">,</span> <span class="n">get_model</span><span class="o">=</span><span class="n">get_model</span><span class="p">)</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mapping_attrs</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs_only</span><span class="p">:</span>
                    <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mapping_data</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">,</span>
                        <span class="n">analysis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__default_basecall_mapping_analysis__</span><span class="p">,</span> <span class="n">get_model</span><span class="o">=</span><span class="n">get_model</span><span class="p">)</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mapping_attrs</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">,</span>
                    <span class="n">analysis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__default_alignment_analysis__</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot find any mapping data at paths I know about. &quot;</span>
                    <span class="s2">&quot;Consider using get_mapping_data() with analysis argument.&quot;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs_only</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">get_model</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">events</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">events</span><span class="p">,</span> <span class="n">attrs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">attrs</span></div>


<div class="viewcode-block" id="Fast5.get_mapping_attrs"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.get_mapping_attrs">[docs]</a>    <span class="nd">@docstring_parameter</span><span class="p">(</span><span class="n">__base_analysis__</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_mapping_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">__default_section__</span><span class="p">,</span> <span class="n">analysis</span><span class="o">=</span><span class="n">__default_mapping_analysis__</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the annotated mapping meta data from the fast5 file.</span>
<span class="sd">        Names which are inconsistent between squiggle_mapping and basecall_mapping are added to</span>
<span class="sd">        basecall_mapping (thus duplicating the attributes in basecall mapping).</span>

<span class="sd">        :param section: String to use in paths, e.g. &#39;template&#39;.</span>
<span class="sd">        :param analysis: Base analysis name (under {})</span>
<span class="sd">                         For basecall mapping use analysis = &#39;Alignment&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">attrs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">analysis</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_mapping_analysis__</span><span class="p">:</span>
            <span class="c1"># squiggle_mapping</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_latest</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>
            <span class="n">attr_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_mapping_summary__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="n">_clean_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">attr_path</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not retrieve squiggle_mapping meta data from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr_path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># basecall_mapping</span>

            <span class="c1"># AligToRef attributes (set AlignToRef first so that Alignment attrs are not overwritten)</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_latest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__default_basecall_mapping_analysis__</span><span class="p">)</span>
            <span class="n">attr_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_basecall_mapping_summary__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="n">_clean_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">attr_path</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not retrieve basecall_mapping meta data from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr_path</span><span class="p">))</span>

            <span class="c1"># Rename some of the fields</span>
            <span class="n">rename</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;genome_start&#39;</span><span class="p">,</span> <span class="s1">&#39;ref_start&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;genome_end&#39;</span><span class="p">,</span> <span class="s1">&#39;ref_stop&#39;</span><span class="p">),</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="n">rename</span><span class="p">:</span>
                <span class="n">attrs</span><span class="p">[</span><span class="n">new</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>

            <span class="c1"># Alignment attributes</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_latest</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>
            <span class="n">attr_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span>
                <span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_basecall_alignment_summary__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">genome</span> <span class="o">=</span> <span class="n">_clean_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">attr_path</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)[</span><span class="s1">&#39;genome&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not retrieve basecall_mapping genome field from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr_path</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_reference_fasta</span><span class="p">(</span><span class="n">section</span> <span class="o">=</span> <span class="n">section</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not retrieve basecall_mapping fasta from Alignment analysis&#39;</span><span class="p">)</span>

            <span class="c1"># Add attributes with keys consistent with Squiggle_map</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="s1">&#39;_rc&#39;</span>
            <span class="n">is_rc</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ref_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">genome</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">rc</span><span class="p">)]</span> <span class="k">if</span> <span class="n">is_rc</span> <span class="k">else</span> <span class="n">genome</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="s1">&#39;-&#39;</span> <span class="k">if</span> <span class="n">is_rc</span> <span class="k">else</span> <span class="s1">&#39;+&#39;</span>

        <span class="c1"># Trim any other fields, the allowed are those produced by</span>
        <span class="c1">#   squiggle_mapping. We allow strand_score but do not require</span>
        <span class="c1">#   it since our writer does not require it.</span>
        <span class="n">required</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">,</span> <span class="s1">&#39;ref_start&#39;</span><span class="p">,</span> <span class="s1">&#39;ref_stop&#39;</span><span class="p">,</span> <span class="s1">&#39;ref_name&#39;</span><span class="p">,</span>
            <span class="s1">&#39;num_skips&#39;</span><span class="p">,</span> <span class="s1">&#39;num_stays&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span>
        <span class="p">]</span>
        <span class="n">additional</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;strand_score&#39;</span><span class="p">,</span> <span class="s1">&#39;shift&#39;</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="s1">&#39;drift&#39;</span><span class="p">,</span> <span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="s1">&#39;scale_sd&#39;</span><span class="p">,</span> <span class="s1">&#39;var_sd&#39;</span><span class="p">]</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="n">required</span> <span class="o">+</span> <span class="n">additional</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">required</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">attrs</span><span class="p">)),</span> <span class="s1">&#39;Required mapping attributes not found&#39;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">keep</span><span class="p">)):</span>
            <span class="k">del</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">attrs</span></div>

    <span class="c1">###</span>
    <span class="c1"># Sequence data</span>

<div class="viewcode-block" id="Fast5.get_fastq"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.get_fastq">[docs]</a>    <span class="nd">@docstring_parameter</span><span class="p">(</span><span class="n">__base_analysis__</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_fastq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis</span><span class="o">=</span><span class="n">__default_basecall_1d_analysis__</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">__default_seq_section__</span><span class="p">,</span> <span class="n">custom</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the fastq (sequence) data.</span>

<span class="sd">        :param analysis: Base analysis name (under {})</span>
<span class="sd">        :param section: (Probably) &#39;template&#39;</span>
<span class="sd">        :param custom: Custom hdf path overriding all of the above.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;Could not retrieve sequence data from </span><span class="si">{}</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="n">custom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">custom</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_latest</span><span class="p">(</span><span class="n">analysis</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_basecall_fastq__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fastq</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">location</span><span class="p">][()]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># Did we get given section != template and no analysis, that&#39;s</span>
            <span class="c1">#    more than likely incorrect. Try alternative analysis</span>
            <span class="k">if</span> <span class="n">section</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_seq_section__</span> <span class="ow">and</span> <span class="n">analysis</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__default_basecall_1d_analysis__</span><span class="p">:</span>
                <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_latest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__default_basecall_1d_analysis__</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__default_basecall_fastq__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fastq</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">location</span><span class="p">][()]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">location</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">location</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fastq</span> <span class="o">=</span> <span class="n">_sanitize_data_for_reading</span><span class="p">(</span><span class="n">fastq</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fastq</span></div>

<div class="viewcode-block" id="Fast5.get_sam"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.get_sam">[docs]</a>    <span class="nd">@docstring_parameter</span><span class="p">(</span><span class="n">__base_analysis__</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_sam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis</span><span class="o">=</span><span class="n">__default_alignment_analysis__</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">__default_seq_section__</span><span class="p">,</span> <span class="n">custom</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get SAM (alignment) data.</span>

<span class="sd">        :param analysis: Base analysis name (under {})</span>
<span class="sd">        :param section: (Probably) &#39;template&#39;</span>
<span class="sd">        :param custom: Custom hdf path overriding all of the above.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">custom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">custom</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_latest</span><span class="p">(</span><span class="n">analysis</span><span class="p">),</span> <span class="s1">&#39;Aligned_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">),</span> <span class="s1">&#39;SAM&#39;</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">location</span><span class="p">][()]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not retrieve SAM data from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">location</span><span class="p">))</span></div>


<div class="viewcode-block" id="Fast5.get_reference_fasta"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.Fast5.get_reference_fasta">[docs]</a>    <span class="nd">@docstring_parameter</span><span class="p">(</span><span class="n">__base_analysis__</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_reference_fasta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis</span><span class="o">=</span><span class="n">__default_alignment_analysis__</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="n">__default_seq_section__</span><span class="p">,</span> <span class="n">custom</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get fasta sequence of known DNA fragment for the read.</span>

<span class="sd">        :param analysis: Base analysis name (under {})</span>
<span class="sd">        :param section: (Probably) &#39;template&#39;</span>
<span class="sd">        :param custom: Custom hdf path overriding all of the above.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">custom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">custom</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_path</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_latest</span><span class="p">(</span><span class="n">analysis</span><span class="p">),</span> <span class="s1">&#39;Aligned_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">),</span> <span class="s1">&#39;Fasta&#39;</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sequence</span> <span class="o">=</span> <span class="n">_sanitize_data_for_reading</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">location</span><span class="p">][()])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not retrieve sequence data from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">location</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">sequence</span></div></div>


<div class="viewcode-block" id="recursive_glob"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.recursive_glob">[docs]</a><span class="k">def</span> <span class="nf">recursive_glob</span><span class="p">(</span><span class="n">treeroot</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
    <span class="c1"># Emulates e.g. glob.glob(&quot;**/*.fast5&quot;&quot;, recursive=True) in python3</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">base</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">treeroot</span><span class="p">):</span>
        <span class="n">goodfiles</span> <span class="o">=</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">goodfiles</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="iterate_fast5"><a class="viewcode-back" href="../../fast5_research.html#fast5_research.fast5.iterate_fast5">[docs]</a><span class="k">def</span> <span class="nf">iterate_fast5</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;Stream&#39;</span><span class="p">,</span> <span class="n">strand_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                  <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterate over directory of fast5 files, optionally only returning those in list</span>

<span class="sd">    :param path: Directory in which single read fast5 are located or filename.</span>
<span class="sd">    :param strand_list: List of strands, can be a python list of delimited</span>
<span class="sd">        table. If the later and a filename field is present, this is used</span>
<span class="sd">        to locate files. If a file is given and a strand field is present,</span>
<span class="sd">        the directory index file is searched for and filenames built from that.</span>
<span class="sd">    :param paths: Yield file paths instead of fast5 objects.</span>
<span class="sd">    :param mode: Mode for opening files.</span>
<span class="sd">    :param limit: Limit number of files to consider.</span>
<span class="sd">    :param shuffle: Shuffle files to randomize yield of files.</span>
<span class="sd">    :param robust: Carry on with iterating over FAST5 files after an exception was raised.</span>
<span class="sd">    :param progress: Display progress bar.</span>
<span class="sd">    :param recursive: Perform a recursive search for files in subdirectories of `path`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">strand_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#  Could make glob more specific to filename pattern expected</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
                <span class="n">files</span> <span class="o">=</span> <span class="n">recursive_glob</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;*.fast5&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">files</span> <span class="o">=</span> <span class="n">iglob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;*.fast5&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">strand_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">strand_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reads</span> <span class="o">=</span> <span class="n">readtsv</span><span class="p">(</span><span class="n">strand_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;filename&#39;</span> <span class="ow">in</span> <span class="n">reads</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="c1">#  Strand list contains a filename column</span>
                <span class="n">files</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">reads</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Strand file does not contain required field &#39;filename&#39;.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># shuffle means we can&#39;t be lazy</span>
    <span class="k">if</span> <span class="n">shuffle</span> <span class="ow">and</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="n">limit</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">shuffle</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">files</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">progress</span><span class="p">:</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">()</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">bar</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">{}</span><span class="s1"> does not exist, skipping</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">paths</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fh</span> <span class="o">=</span> <span class="n">Fast5</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">robust</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Could not open FAST5 file </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">fh</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_type_meta</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert meta data fields into required types.</span>
<span class="sd">    :param meta: dict of values</span>
<span class="sd">    :param: types: dict of types or `np.dtype`</span>

<span class="sd">    :returns: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">converted</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">meta</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">converted</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">converted</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2017, Oxford Nanopore Technologies

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>